<html>

<head>
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="Content-type" value="text/html; charset=UTF-8" />
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/solid.css"
        integrity="sha384-r/k8YTFqmlOaqRkZuSiE9trsrDXkh07mRaoGBMoDcmA58OHILZPsk29i2BsFng1B" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css"
        integrity="sha384-4aon80D8rXCGx9ayDt85LbyUHeMWd3UiBaWliBlJ53yzm9hqN21A+o1pqoyK04h+" crossorigin="anonymous">
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
    <script src="https://vuejs.org/js/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.0/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        @font-face {
            /*Metropolis-Thin*/
            font-family: 'Metropolis-Thin';
            src: url('/fonts/Metropolis-Thin.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            /*Metropolis-Regular*/
            font-family: 'Metropolis-Regular';
            src: url('/fonts/Metropolis-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        .mobile .image-button {
            font-size: 5em;
        }

        .templates {
            display: none;
        }

        h1 {
            font-family: Metropolis-Regular;
            font-size: 4em;
        }

        body {
            width: calc(100% - 50px);
            height: calc(100% - 50px);
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 25px;
            margin-bottom: 25px;
            background: #111;
            background-repeat: repeat-y;
            font-family: Metropolis-Thin;
            user-select: none;
        }

        .page-header,
        .page-footer {
            font-family: Metropolis-Thin;
            background: #292929;
            color: #FFFFFF;
            padding: 10px;
            user-select: none;
        }

        .page-header>h1,
        .page-footer h2 {
            margin: 15px;
        }

        .page-footer {
            margin-bottom: 15px;
        }

        .page-footer h2 {
            color: #353535;
            font-size: 2em;
        }

        .page-footer h2 span.right {
            float: right;
            color: #EEE;
        }

        .post {
            clear: both;
            padding-top: 10px;
            padding-bottom: 10px;
            overflow: hidden;
            min-height: 485px;
        }

        .post-images {
            float: left;
            position: relative;
            border-right: solid 10px #00000000;
            user-select: none;
            max-width: 75%;
            overflow: hidden;
            user-select: none;
        }

        .post-images img {
            height: 485px;
        }

        .post-images.collapsed img {
            max-width: 200px;
            object-fit: cover;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        div.spinner {
            z-index: 100;
            background: rgba(255, 255, 255, 0.2);
            color: #292929AA;
            font-size: 4em;
            font-weight: bold;
            display: block;
            width: 1.05em;
            height: 1.05em;
            transform: translate(-50%, -50%);
            position: absolute;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            text-align: center;
        }

        .spinner span {
            display: block;
            animation-name: spin;
            animation-duration: 1000ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        span.date {
            position: absolute;
            right: 5px;
            bottom: 5px;
            color: #292929AA;
            font-size: 0.7em;
            font-style: italic;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px;
            border-radius: 8px;
        }

        .image-button {
            z-index: 100;
            font-size: 3em;
            display: block;
            position: absolute;
            width: 1em;
            height: 1.2em;
            text-align: center;
            cursor: pointer;
            width: 1.1em;
            height: 1.1em;
            box-sizing: border-box;
            user-select: none;
            opacity: 0.5;
        }

        .image-button:hover {
            opacity: 1;
        }

        .post-images .collapser {
            color: #555;
            right: 10px;
            top: 10px;
            mix-blend-mode: difference;
        }

        .next,
        .prev {
            top: calc(50% - 0.3em);
            border-radius: 50%;
            background: rgba(200, 200, 200, 0.65);
            color: #292929;
            padding-top: 0.035em;
        }

        .prev {
            left: 10px;
        }

        .next {
            right: 10px;
        }

        .post-images.collapsed .prev {
            display: none;
        }

        .post-images.collapsed .next {
            display: none;
        }

        .post-text {
            background: #292929;
            height: 485px;
            color: #FFF;
            overflow-y: scroll;
            padding: 10px;
            box-sizing: border-box;
            border-bottom: solid 10px #292929;
            border-top: solid 10px #292929;
            scrollbar-color: #888 #292929;
            scrollbar-width: thin;
        }

        .post-text .title {
            margin-left: 10px;
            border-bottom: solid 2px #222;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        .post-text .title h2 {
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .post-text .title .post-date {
            font-size: 0.80em;
            font-style: italic;
            color: #AAA;
        }

        .post-text .post-text-body {
            margin: 10px;
        }

        .post-text-body {
            line-height: 140%;
            font-size: 0.95em;
            user-select: text;
        }

        .post-text-body p {
            margin-bottom: 1em;
        }

        .post-text::-webkit-scrollbar {
            width: 10px;
        }

        .post-text::-webkit-scrollbar-track {
            background: #292929;
        }

        .post-text::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        .post-text::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        div.lightbox {
            position: fixed;
            top: 0px;
            right: 0px;
            bottom: 0px;
            left: 0px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            cursor: zoom-out;
            transition: opacity 0.5s;
        }

        div.lightbox img {
            z-index: 1000;
            max-height: calc(100% - 30px);
            max-width: calc(100% - 30px);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            transition: opacity 0.5s;
            cursor: zoom-in;
        }

        div.lightbox img.zoomed {
            cursor: zoom-out;
            object-fit: none;
        }

        div.lightbox .image-button.close {
            z-index: 1100;
            position: fixed;
            right: 0.4em;
            top: 0.2em;
            background: none;
            color: #AAAAAA;
            border-radius: 50%;
        }

        div.lightbox .image-button.close:hover {
            color: #FFFFFF;
            mix-blend-mode: exclusion;
        }

        div.lightbox .image-button {
            background: rgba(255, 255, 255, 0.4);
            color: #29292999;
        }

        .lightbox .next,
        .lightbox .prev {
            z-index: 1100;
        }

        a.anchor {
            display: block;
            position: relative;
            top: -100px;
            visibility: hidden;
        }

        em.music {
            background: #88888844;
            border-radius: 0.3em;
            padding-left: 0.2em;
            padding-right: 0.28em;
            padding-top: 0.2em;
            padding-bottom: 0.1em;
            cursor: pointer;
            position: relative;
            box-sizing: border-box;
            border: solid 1px #88888800;
        }

        em.music:hover {
            background: #88888855;
        }

        em.music.open {
            background: none;
            border: solid 1px #88888844;
            border-bottom-right-radius: 0px;
            border-bottom-left-radius: 0px;
            border-bottom: none;
            user-select: none;
        }

        em.music div.music-popup {
            display: block;
            position: absolute;
            background:#666666DD;
            padding: 10px;
            width: 12em;
            font-style: normal;
            text-align: center;
            cursor: default;
            font-weight: bold;
            border-radius: 0.3em;
            border-top-left-radius: 0px;
        }

        em.music div.music-popup > div.names {
            text-align: left;
        }

        em.music div.music-popup > div.images {
            margin-left: auto;
            margin-right: auto;
            display: inline-block;
            padding: 0px;
            margin-top: 10px;
        }

        em.music div.music-popup > div a {
            margin-left: 0.4em;
            margin-right: 0.4em;
        }

        em.music div.music-popup > div img {
            width: 3em;
            vertical-align: middle;
            filter: saturate(0.9);
        }

        em.music div.music-popup > div img:hover {
            width: 3em;
            vertical-align: middle;
            filter: saturate(1.2) contrast(1.2)
        }

        em.music div.music-popup > div img:first-child {
            margin-left: 0;
        }

        em.music div.music-popup > div img:last-child {
            margin-right: 0;
        }

        em.music .close-music {
            font-size: 12px + 8em;
            font-weight: normal;
            position: absolute;
            right: 0.6em;
            top: 0.5em;
            display: block;
            color: #000;
            cursor: pointer;
            filter: contrast(2);
            border-radius: 50%;
            height: 1.24em;
            width: 1.24em;
        }

        em.music .close-music:hover {
            color: #FFF;
            background: #FFFFFF44;
        }
    </style>
    <script>
        const clamp = (num, min, max) => {
            return num <= min
                ? min
                : num >= max
                    ? max
                    : num;
        }

        const mdRenderer = new showdown.Converter();
        mdRenderer.setOption('headerLevelStart', 3);
        mdRenderer.setOption('strikethrough', true);
        mdRenderer.setOption('emoji', true);
        const getTemplate = scriptElement => document.currentScript.parentElement.children[0].innerHTML;
        const renderMarkdown = markdown => mdRenderer.makeHtml(markdown);
        const updateSlug = (post, allposts) => {
            const title = `Just Call Me Ryan | ${post.title}`;
            document.title = title;

            if (post == allposts[0])
                window.history.replaceState(null, title, window.location.pathname)
            else
                window.history.replaceState(null, title, `#${post.slug}`);            
        }
        const getLightboxSlug = (post, image) => {
            return `#lightbox_${post.slug}_${post.images.indexOf(image)}`;
        }
        const updateLightboxSlug = (post, image) => {
            const title = `Just Call Me Ryan | ${post.title}`;
            window.history.replaceState(null, title, getLightboxSlug(post, image));  
        }
        const getViewportData = el => {
            const rect = el.getBoundingClientRect();
            const windowHeight = (window.innerHeight || document.documentElement.clientHeight);
            const topMargin = rect.top;
            const bottomMargin = windowHeight - (rect.top + rect.height);
            return { topMargin, bottomMargin, height: rect.height };
        }
        const parseOpts = innerText => {
            const args = {};
            let currentAttrName = "";
            let currentValue = "";
            let inValue = false;
            for (let char of innerText.substring("music-item ".length)) {
                if (!inValue)
                {
                    if (char == "=")
                    {
                        inValue = true;
                        continue;
                    }
                
                    if (char == " ")
                        continue;
                    currentAttrName += char;
                    continue;
                }

                if (inValue)
                {
                    currentValue += char;
                    if (char == '"' && currentValue.length > 1)
                    {
                        args[currentAttrName] = currentValue.substring(1, currentValue.length - 1);
                        currentAttrName = "";
                        currentValue = "";
                        inValue = false;
                    }
                    continue;
                }
            }
            return {spotify: args.spotify, google: args.google, youtube: args.youtube, track: args.track, artist: args.artist};
        }
        const insertMusic = html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const musicItems = [...doc.querySelectorAll("del")].filter(del => del.innerText.startsWith("music-item"));
            musicItems.forEach(item => {
                const props = parseOpts(item.innerText);
                const divElement = doc.createElement('div');
                item.parentElement.replaceChild(divElement, item);
                const musicComponent = new (Vue.component('music'))({
                    el: divElement,
                    propsData: props
                });
            })
            return doc.body;
        }
    </script>
</head>

<body>
    <div id="app" :class="{mobile}">
        <page-header></page-header>
        <post v-for="post of posts" :post="post" :key="post.slug" @became-active="activeChanged"
            @lightbox="handleLightbox">
        </post>
        <page-footer></page-footer>
        <lightbox v-if="lightboxImage != null" :image="lightboxImage" :post="lightboxPost" @closed="closeLightbox"
            @prev="handleLightboxPrev" @next="handleLightboxNext">
        </lightbox>
    </div>
    <div class="templates">
        <div id="page-header">
            <div class="template">
                <div class="page-header">
                    <h1>Just Call Me Ryan</h1>
                </div>
            </div>
            <script>
                Vue.component('page-header', {
                    template: getTemplate()
                })
            </script>
        </div>
        <div id="post">
            <div class="template">
                <div class="post" :style="{'mask-image': mask, 'mask-mode': 'luminance'}">
                    <a :name="post.slug" class="anchor"></a>
                    <post-images v-if="inView" :post="post" @lightbox="handleLightbox"></post-images>
                    <post-text v-if="inView" :post="post"></post-text>
                </div>
            </div>
            <script>
                Vue.component('post', {
                    template: getTemplate(),
                    props: ['post', 'activeSlug'],
                    computed: {
                        lossInfo: vm => {
                            const pixelLoss = -Math.min(vm.viewportData.topMargin, vm.viewportData.bottomMargin);
                            const direction = vm.viewportData.topMargin > vm.viewportData.bottomMargin
                                ? "top"
                                : "bottom";
                            return { pixelLoss, direction };
                        },
                        gradientEnabled: vm => vm.viewportData.height + 110 < (window.innerHeight || document.documentElement.clientHeight),
                        mask: vm => {
                            const loss = vm.lossInfo;
                            return vm.gradientEnabled
                                ? `linear-gradient(to ${loss.direction}, rgba(255, 0, 0, 0) ${loss.pixelLoss + 20}px, black ${loss.pixelLoss + 120}px)`
                                : `none`;
                        },
                        inView: vm => vm.lossInfo.pixelLoss < vm.viewportData.height
                    },
                    methods: {
                        handleLightbox(image) {
                            this.$emit("lightbox", image, this.post);
                        },
                        handleScroll() {
                            const viewport = getViewportData(this.$el);
                            const viewportOutRatio = Math.min(viewport.topMargin, viewport.bottomMargin) / viewport.height;
                            if (viewportOutRatio > -2) {
                                this.viewportData = viewport;
                                if (!this.post.active && viewport.topMargin + (viewport.height / 4) > 0 && viewport.topMargin < viewport.height / 2)
                                    this.$emit("became-active", this.post);
                            }
                        }
                    },
                    mounted() {
                        window.addEventListener('scroll', this.handleScroll);
                        window.addEventListener('resize', this.handleScroll);
                        this.handleScroll();
                    },
                    unmounted() {
                        window.removeEventListener('scroll', this.handleScroll);
                        window.removeEventListener('resize', this.handleScroll);
                    },
                    data: () => ({ viewportData: {} })
                })
            </script>
        </div>
        <div id="post-images">
            <div class="template">
                <div class="post-images" :class="{collapsed: isCollapsed}" @click="outerClick">
                    <span class="collapser image-button" @click.stop="isCollapsed = !isCollapsed"
                        v-html="collapseText"></span>
                    <span class="image-button prev" v-if="post.images.length > 1"
                        @click.stop="imageIndex = imageIndex == 0 ? (post.images.length - 1) : imageIndex - 1"><i
                            class="fas fa-arrow-left"></i></span>
                    <span class="image-button next" v-if="post.images.length > 1"
                        @click.stop="imageIndex = (imageIndex + 1) % post.images.length"><i
                            class="fas fa-arrow-right"></i></span>
                    <span v-if="currentImage.date" class="date" :title="currentImage.date">{{currentImage.date}}</span>
                    <div v-if="loading" class="spinner">
                        <span>r</span>
                    </div>
                    <a :href="hash" @click.prevent="emitLightbox">
                        <img :style="{filter: loading ? 'brightness(50%)' : 'none'}" @load="imageLoaded"
                            :src="currentImage.thumb" />
                    </a>
                </div>
            </div>
            <script>
                Vue.component('post-images', {
                    template: getTemplate(),
                    props: ['post'],
                    computed: {
                        currentImage: vm => vm.post.images[vm.imageIndex],
                        collapseText: vm => vm.isCollapsed ? "<i class='fas fas fa-chevron-right'></i>" : "<i class='fas fa-chevron-left'></i>",
                        isCollapsed: {
                            get: vm => vm.post.collapsed,
                            set: function (val) { this.post.collapsed = val; }
                        },
                        hash: vm => getLightboxSlug(vm.post, vm.currentImage)
                    },
                    methods: {
                        emitLightbox: function () {
                            if (!this.isCollapsed)
                                this.$emit("lightbox", this.currentImage);
                        },
                        outerClick: function (e) {
                            if (this.isCollapsed) {
                                this.isCollapsed = false;
                                e.preventDefault();
                            }
                        },
                        imageLoaded: function () {
                            this.loading = false;
                            this.loadingInternal = false;
                            if (this.currentImage.date)
                                return;

                            const vm = this;
                            var img = this.$el.querySelector("img");
                            delete img.exifdata;
                            EXIF.getData(img, function () {
                                let all = EXIF.getAllTags(this);
                                var dateTime = EXIF.getTag(this, "DateTimeOriginal");

                                if (dateTime) {
                                    var b = dateTime.split(/\D/);
                                    var date = new Date(b[0], b[1] - 1, b[2], b[3], b[4], b[5]).toLocaleString("en-US", { month: "long", "day": "numeric", "year": "numeric" });
                                    vm.currentImage.date = date;
                                }
                            });
                        }
                    },
                    watch: {
                        imageIndex: function () {
                            this.loadingInternal = true;
                            setTimeout(() => {
                                if (this.loadingInternal)
                                    this.loading = true;
                            }, 100);
                        }
                    },
                    data: () => ({
                        imageIndex: 0,
                        loading: true,
                        loadingInternal: true
                    })
                })
            </script>
        </div>
        <div id="post-text">
            <div class="template">
                <div class="post-text">
                    <div class="title">
                        <span class="post-date">{{ post.date }}</span>
                        <h2>{{ post.title }}</h2>
                    </div>
                    <div class="post-text-body">

                    </div>
                </div>
            </div>
            <script>
                Vue.component('post-text', {
                    template: getTemplate(),
                    props: ['post'],
                    mounted: function () {
                        if (this.post.markdown) {
                            this.markdown = this.post.markdown;
                            return;
                        }
                        fetch("md/" + this.post.slug + ".md")
                            .then(response => response.text())
                            .then(markdown => this.markdown = markdown);
                    },
                    watch: {
                        markdown: function() {
                            const document = insertMusic(renderMarkdown(this.markdown))
                            const textBody = this.$el.querySelector('.post-text-body');
                            const newBody = textBody.cloneNode(false);
                            textBody.parentNode.replaceChild(newBody, textBody);
                            for(let child of document.childNodes)
                                newBody.appendChild(child);
                        }
                    },
                    data: () => ({ markdown: "" })
                })
            </script>
        </div>
        <div id="page-footer">
            <div class="template">
                <div class="page-footer">
                    <h2>ryan rosie boberts jobo dirty joze llama jo josiah <span class="right">Copyright
                            {{ (new Date()).getFullYear() }}</span></h2>
                </div>
            </div>
            <script>
                Vue.component('page-footer', {
                    template: getTemplate()
                })
            </script>
        </div>
        <div id="lightbox">
            <div class="template">
                <div class="lightbox" @click="close" :style="{opacity}">
                    <span class="image-button prev" v-if="post.images.length > 1 && currentIndex > 0"
                        @click.stop="prev"><i class="fas fa-arrow-left"></i></span>
                    <span class="image-button next"
                        v-if="post.images.length > 1 && currentIndex < post.images.length - 1" @click.stop="next"><i
                            class="fas fa-arrow-right"></i></span>
                    <a :href="image.full" target="_blank">
                        <img :class="{zoomed}"
                            :style="{'object-position': zoomed ? position : 'initial', opacity: imageOpacity}"
                            @mousemove="mouseMove" @click.stop.prevent="zoom" @touchstart.prevent="touchStart"
                            @touchend.prevent="touchEnd" @touchmove.prevent="touchMove" :src="image.full"
                            @load="loaded">
                        </img>
                    </a>
                    <span class="image-button close" @click="close">&#x2715;</span>
                    <div class="spinner">
                        <span>r</span>
                    </div>
                </div>
            </div>
            <script>
                Vue.component('lightbox', {
                    template: getTemplate(),
                    props: ['image', 'post'],
                    computed: {
                        currentIndex: vm => vm.post.images.indexOf(vm.image)
                    },
                    methods: {
                        touchStart: function () {
                            this.wasZoomedBeforeLastTouch = this.zoomed;
                            if (!this.zoomed)
                                this.zoomed = true;
                            this.lastTouchStart = Date.now();
                        },
                        touchEnd: function () {
                            if (Date.now() - this.lastTouchStart < 200 && this.wasZoomedBeforeLastTouch)
                                this.zoom();
                        },
                        zoom: function () {
                            this.zoomed = !this.zoomed;
                        },
                        pan: function (position) {
                            let imageRect = position.target.getBoundingClientRect();
                            let xPosition = (position.clientX - imageRect.left) / imageRect.width;
                            let yPosition = (position.clientY - imageRect.top) / imageRect.height;
                            this.position = `${clamp(xPosition * 100, 0, 100)}% ${clamp(yPosition * 100, 0, 100)}%`;
                        },
                        touchMove: function (e) {
                            let image = this.$el.querySelector("img");
                            this.pan([...e.changedTouches].filter(x => x.target == image)[0]);
                            if (this.zoomed)
                                e.preventDefault();
                        },
                        mouseMove: function (e) {
                            this.pan(e);
                        },
                        close: function () {
                            this.opacity = 0;
                            setTimeout(() => {
                                this.$emit('closed');
                            }, 500);
                        },
                        loaded: function () {
                            this.imageOpacity = 1;
                        },
                        prev: function () {
                            this.imageOpacity = 0;
                            this.$emit('prev');
                        },
                        next: function () {
                            this.imageOpacity = 0;
                            this.$emit('next');
                        }
                    },
                    mounted() {
                        setTimeout(() => this.opacity = 1, 100);
                    },
                    unmounted() {
                        this.opacity = 0;
                    },
                    data: () => ({
                        opacity: 0,
                        imageOpacity: 0,
                        zoomed: false,
                        position: "initial",
                        lastTouchStart: 0,
                        wasZoomedBeforeLastTouch: false
                    })
                })
            </script>
        </div>
        <div id="music">
            <div class="template">
                <em class="music" @click.self="togglePopup" :class="{open: popup}">{{track}}<div class="music-popup" v-if="popup">
                    <div class="names">
                        {{track}}<br />
                        <small>{{artist}}</small>
                    </div>
                    <div class="images">
                        <a v-if="spotify" :href="spotify"><img src="spotify.png"></img></a>
                        <a v-if="youtube" :href="youtube"><img src="youtube.png"></img></a>
                        <a v-if="google" :href="google"><img src="google.png"></img></a>
                    </div>
                    <span class="close-music" @click="togglePopup">&#x2715;</span>
                </div></em>
            </div>
            <script>
                Vue.component('music', {
                    template: getTemplate(),
                    props: ['spotify', 'youtube', 'google', 'track', 'artist', 'album'],
                    methods: {
                        togglePopup: function(e) {
                            if (!this.popup)
                                document.addEventListener("mousedown", this.clickToClose);
                            else
                                document.removeEventListener("mousedown", this.clickToClose);

                            this.popup = !this.popup;
                        },
                        clickToClose: function(e) {
                            if (this.$el && (e.target == this.$el || this.$el.contains(e.target)))
                                return;
                            
                            this.togglePopup();
                        }
                    },
                    data: () => ({popup: false})
                })
            </script>
        </div>
    </div>
</body>
<script id="app-start">
    var app = new Vue({
        el: '#app',
        created: function () {
            this.mobile = (window.innerWidth / window.devicePixelRatio) < 500;
            fetch("posts.json").then(response => response.json()).then(postsResponse => {
                const visiblePosts = postsResponse.filter(x => !x.hide);
                for (let post of visiblePosts) {
                    post.collapsed = this.mobile;
                    for (let image of post.images) {
                        image.date = "";
                    }
                }
                this.posts = visiblePosts;
            });
        },
        methods: {
            handleLightbox: function (image, post) {
                updateLightboxSlug(post, image);
                this.lightboxPost = post;
                this.lightboxImage = image;
            },
            handleLightboxPrev: function () {
                this.lightboxImage = this.lightboxPost.images[this.lightboxPost.images.indexOf(this.lightboxImage) - 1];
                updateLightboxSlug(this.lightboxPost, this.lightboxImage);
            },
            handleLightboxNext: function () {
                this.lightboxImage = this.lightboxPost.images[this.lightboxPost.images.indexOf(this.lightboxImage) + 1];
                updateLightboxSlug(this.lightboxPost, this.lightboxImage);
            },
            handlePostsLoaded: function () {
                const hash = window.location.hash;
                if (hash.indexOf("lightbox") != -1) {
                    const [_, slug, imageNumber] = hash.substring(hash.indexOf("lightbox")).split("_");
                    this.lightboxPost = this.posts.filter(post => post.slug == slug)[0];
                    this.lightboxImage = this.lightboxPost.images[imageNumber];
                    updateLightboxSlug(this.lightboxPost, this.lightboxImage);
                }
            },
            closeLightbox: function () {
                updateSlug(this.activePost != null ? this.activePost : this.posts[0], this.posts);
                this.lightboxImage = null;
                this.lightboxPost = null;
            },
            activeChanged: function (newActivePost) {
                if (this.lightboxImage)
                    return;

                if (this.activePost)
                    this.activePost.active = false;

                updateSlug(newActivePost, this.posts);
                newActivePost.active = true;
                this.activePost = newActivePost;
            }
        },
        watch: {
            posts: function (newValue) { if (newValue) this.handlePostsLoaded(); }
        },
        data: () => ({
            posts: [],
            lightboxImage: null,
            lightboxPost: null,
            activePost: null,
            mobile: false
        })
    })        
</script>

</html>