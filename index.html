<html>

<head>
    <meta http-equiv="Content-type" value="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.0/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style type="">
        @font-face { /*Metropolis-Thin*/
            font-family: 'Metropolis-Thin';
            src: url('/fonts/Metropolis-Thin.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        @font-face { /*Metropolis-Regular*/
            font-family: 'Metropolis-Regular';
            src: url('/fonts/Metropolis-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        .templates {
            display: none;
        }

        h1 {            
            font-family: Metropolis-Regular;
            font-size: 4em;
        }

        body {            
            width: calc(100% - 50px);
            height: calc(100% - 50px);
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 25px;
            margin-bottom: 25px;
            background: #111;
            background-repeat: repeat-y;
            font-family: Metropolis-Thin;
        }

        .page-header, .page-footer {
            font-family: Metropolis-Thin;
            background: #292929;
            color: #FFFFFF;
            padding: 10px;  
        }

        .page-header > h1, .page-footer h2 {
            margin: 15px;
        }

        .page-footer {
            margin-bottom: 15px;
        }

        .page-footer h2 {
            color: #353535;
        }

        .page-footer h2 span.right {
            float: right;
            color: #EEE;
        }

        .post {
            clear: both;
            padding-top: 10px;
            padding-bottom: 10px;
            overflow: hidden;
            min-height: 485px;
        }

        .post-images {
            float: left;
            position: relative;
            border-right: solid 10px #00000000;
            user-select: none;
            max-width: 75%;
            overflow: hidden;
        }

        .post-images img {
            height: 485px;
        }

        .post-images.collapsed img {
            max-width: 200px;
            object-fit: cover;
        }

        @keyframes spin {
            from {transform:rotate(0deg);}
            to {transform:rotate(360deg);}
        }

        div.spinner {            
            z-index: 100;
            background: rgba(255, 255, 255, 0.2);
            color: #292929AA; 
            font-size: 4em;
            font-weight: bold;
            display: block;
            width: 1.05em;
            height: 1.05em;
            transform: translate(-50%, -50%);
            position: absolute;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            text-align: center;
        }

        .spinner span {
            display: block;
            animation-name: spin;
            animation-duration: 1000ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        span.date {
            position: absolute;
            right: 5px;
            bottom: 5px;
            color: #292929AA; 
            font-size: 0.7em;
            font-style: italic;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px;
            border-radius: 8px;            
        }

        .image-button { 
            z-index: 100;
            color: #292929AA; 
            font-size: 3em;
            display: block;
            position: absolute;
            background: rgba(255, 255, 255, 0.4);
            width: 1em;
            height: 1.2em;
            border-radius: 20%;
            text-align: center;
            cursor: pointer;
        }

        .image-button:hover {            
            background: rgba(200, 200, 200, 0.4);
        }

        .post-images .collapser {            
            right: 10px;
            top: 10px;            
        }

        .post-images .prev {
            padding-right: 8px;
            left: 10px;
            top: calc(50% - 0.6em);
        }

        .post-images .next {
            padding-left: 8px;
            right: 10px;
            top: calc(50% - 0.6em);
        }

        .post-images.collapsed .prev {
            display: none;
        }

        .post-images.collapsed .next {
            display: none;
        }

        .post-text {
            background: #292929;
            height: 485px;
            color: #FFF;
            overflow-y: scroll;
            padding: 10px;
            box-sizing: border-box;
            border-bottom: solid 10px #292929;            
            border-top: solid 10px #292929;
        }

        .post-text .title {
            margin-left: 10px;
            border-bottom: solid 2px #222;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        .post-text .title h2 {
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .post-text .title .date {
            font-size: 0.80em;
            font-style: italic;
        }

        .post-text .post-text-body {
            margin: 10px;
        }

        .post-text-body {
            line-height: 140%;
            font-size: 0.95em;
        }

        .post-text-body p {
            margin-bottom: 10px;
        }

        .post-text::-webkit-scrollbar {            
            width: 10px;
        }

        .post-text::-webkit-scrollbar-track {
            background: #292929; 
        }

        .post-text::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        .post-text::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        div.lightbox {
            position: fixed;
            top: 0px;     
            right: 0px;
            bottom: 0px;
            left: 0px;       
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: opacity 0.5s;
        }

        div.lightbox img {
            z-index: 1000;
            max-height: calc(100% - 30px);
            max-width: calc(100% - 30px);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            transition: opacity 0.5s;
        }

        div.lightbox .image-button.close {
            z-index: 1100;
            position: fixed;
            right: 10px;
            top: 15px;
            font-weight: bold;
            padding-top: 6px;
            padding-left: 0px;
            padding-bottom: 5px;
            height: 1em;
        }

        a.anchor {
            display: block;
            position: relative;
            top: -100px;
            visibility: hidden;
        }
    </style>
    <script>
        const mdRenderer = new showdown.Converter();
        const getTemplate = scriptElement => document.currentScript.parentElement.children[0].innerHTML;
        const renderMarkdown = markdown => mdRenderer.makeHtml(markdown);
        const getViewportData = (el) => {
            const rect = el.getBoundingClientRect();
            const windowHeight = (window.innerHeight || document.documentElement.clientHeight);
            const topMargin = rect.top;
            const bottomMargin = windowHeight - (rect.top + rect.height);
            return { topMargin, bottomMargin, height: rect.height };
        }
    </script>
</head>

<body>
    <div id="app">
        <page-header></page-header>
        <post v-for="post of posts" :post="post" :key="post.slug">
        </post>
        <page-footer></page-footer>
        <lightbox v-if="lightbox != null" :image="lightbox" @closed="closeLightbox"></lightbox>
    </div>
    <div class="templates">
        <div id="page-header">
            <div class="template">
                <div class="page-header">
                    <h1>Just Call Me Ryan</h1>
                </div>
            </div>
            <script>
                Vue.component('page-header', {
                    template: getTemplate()
                })
            </script>
        </div>
        <div id="post">
            <div class="template">
                <div class="post" :style="{'mask-image': mask, 'mask-mode': 'luminance'}">
                    <a :name="post.slug" class="anchor"></a>
                    <post-images v-if="inView" :post="post"></post-images>
                    <post-text v-if="inView" :post="post"></post-text>
                </div>
            </div>
            <script>
                Vue.component('post', {
                    template: getTemplate(),
                    props: ['post'],
                    computed: {
                        lossInfo: vm => {
                            const pixelLoss = -Math.min(vm.viewportData.topMargin, vm.viewportData.bottomMargin);
                            const direction = vm.viewportData.topMargin > vm.viewportData.bottomMargin
                                ? "top"
                                : "bottom";
                            return { pixelLoss, direction };
                        },
                        mask: vm => {
                            const loss = vm.lossInfo;
                            return `linear-gradient(to ${loss.direction}, rgba(255, 0, 0, 0) ${loss.pixelLoss + 20}px, black ${loss.pixelLoss + 120}px)`;
                        },
                        inView: vm => vm.lossInfo.pixelLoss < vm.viewportData.height
                    },
                    methods: {
                        handleScroll() {
                            const viewport = getViewportData(this.$el);
                            const viewportOutMargin = Math.min(viewport.topMargin, viewport.bottomMargin);
                            const viewportOutRatio = viewportOutMargin / viewport.height;
                            if (viewportOutRatio > -1.6)
                                this.viewportData = viewport;
                        }
                    },
                    mounted() {
                        window.addEventListener('scroll', this.handleScroll);
                        this.handleScroll();
                    },
                    unmounted() {
                        window.removeEventListener('scroll', this.handleScroll);
                    },
                    data: () => ({ viewportData: {} })
                })
            </script>
        </div>
        <div id="post-images">
            <div class="template">
                <div class="post-images" :class="{collapsed: isCollapsed}" @click="outerClick">
                    <span class="collapser image-button" @click.stop="isCollapsed = !isCollapsed" v-html="collapseText"></span>
                    <span class="image-button prev" v-if="post.images.length > 1"
                        @click="imageIndex = imageIndex == 0 ? (post.images.length - 1) : imageIndex - 1">&#9668;</span>
                    <span class="image-button next" v-if="post.images.length > 1"
                        @click="imageIndex = (imageIndex + 1) % post.images.length">&#9658;</span>
                    <span v-if="currentImage.date" class="date">{{currentImage.date}}</span>
                    <div v-if="loading" class="spinner">
                        <span>r</span>
                    </div>
                    <a :href="`#lightbox_${post.slug}_${post.images.indexOf(currentImage)}`">
                        <img :style="{filter: loading ? 'brightness(50%)' : 'none'}" @load="imageLoaded" :src="currentImage.thumb" />
                    </a>
                </div>
            </div>
            <script>
                Vue.component('post-images', {
                    template: getTemplate(),
                    props: ['post'],
                    computed: {
                        currentImage: vm => vm.post.images[vm.imageIndex],
                        collapseText: vm => vm.isCollapsed ? "&#10219;" : "&#10218;",
                        isCollapsed: {
                            get: vm => vm.post.collapsed,
                            set: function (val) { this.post.collapsed = val; }
                        }
                    },
                    methods: {
                        outerClick: function(e) {
                            if (this.isCollapsed)
                            {
                                this.isCollapsed = false;
                                e.preventDefault();
                            }
                        },
                        imageLoaded: function() {
                            this.loading = false;
                            this.loadingInternal = false;
                            if (this.currentImage.date)
                                return;

                            const vm = this;
                            var img = this.$el.querySelector("img");
                            delete img.exifdata;
                            EXIF.getData(img, function() {
                                var dateTime = EXIF.getTag(this, "DateTime");

                                if (dateTime)
                                {
                                    var b = dateTime.split(/\D/);
                                    var date = new Date(b[0],b[1]-1,b[2],b[3],b[4],b[5]).toLocaleString("en-US", {month: "long", "day": "numeric", "year": "numeric"});
                                    vm.currentImage.date = date;
                                }
                            });
                        }
                    },
                    watch: {
                        imageIndex: function() {
                            this.loadingInternal = true;
                            setTimeout(() => {
                                if (this.loadingInternal)
                                    this.loading = true;
                            }, 100);
                        }
                    },
                    data: () => ({
                        imageIndex: 0,
                        loading: true,
                        loadingInternal: true
                    })
                })
            </script>
        </div>
        <div id="post-text">
            <div class="template">
                <div class="post-text">
                    <div class="title">
                        <span class="date">{{ post.date }}</span>
                        <h2>{{ post.title }}</h2>
                    </div>
                    <div class="post-text-body" v-html="html">

                    </div>
                </div>
            </div>
            <script>
                Vue.component('post-text', {
                    template: getTemplate(),
                    props: ['post'],
                    computed: {
                        html: vm => renderMarkdown(vm.markdown)
                    },
                    mounted: async function () {
                        if (this.post.markdown) {
                            this.markdown = this.post.markdown;
                            return;
                        }
                        this.markdown = await fetch("md/" + this.post.slug + ".md").then(response => response.text());
                    },
                    data: () => ({ markdown: "" })
                })
            </script>
        </div>
        <div id="page-footer">
            <div class="template">
                <div class="page-footer">
                    <h2>ryan rosie boberts jobo dirty joze llama jo josiah <span class="right">Copyright {{ (new Date()).getFullYear() }}</span></h2>
                </div>
            </div>
            <script>
                Vue.component('page-footer', {
                    template: getTemplate()
                })
            </script>
        </div>
        <div id="lightbox">
            <div class="template">
                <div class="lightbox" @click="close" :style="{opacity}">
                    <a :href="image.full" target="_blank">
                        <img :src="image.full" @load="loaded" :style="{opacity: imageOpacity}"></img>
                    </a>
                    <span class="image-button close" @click="close">X</span>
                    <div class="spinner">
                        <span>r</span>
                    </div>
                </div>
            </div>
            <script>
                Vue.component('lightbox', {
                    template: getTemplate(),
                    props: ['image'],
                    methods: {
                        close: function () {
                            this.opacity = 0;
                            setTimeout(() => {
                                this.$emit('closed');
                            }, 500);
                        },
                        loaded: function () {
                            this.imageOpacity = 1;
                        }
                    },
                    mounted() {
                        setTimeout(() => this.opacity = 1, 100);
                    },
                    unmounted() {
                        this.opacity = 0;
                    },
                    data: () => ({ opacity: 0, imageOpacity: 0 })
                })
            </script>
        </div>
    </div>
</body>
<script id="app-start">
    var app = new Vue({
        el: '#app',
        created: async function () {
            window.addEventListener("hashchange", this.handleHashChange);
            const postsResponse = await fetch("posts.json").then(response => response.json());
            for (let post of postsResponse) {
                post.collapsed = (window.innerWidth / window.devicePixelRatio) < 500;
                for (let image of post.images) {
                    image.date = "";
                }
            }
            this.posts = postsResponse;
        },
        destroyed() {
            window.removeEventListener('hashchange', this.handleHashChange);
        },
        methods: {
            handleHashChange: function () {
                const hash = window.location.hash;
                if (hash.indexOf("lightbox") != -1) {
                    const [_, slug, imageNumber] = hash.substring(hash.indexOf("lightbox")).split("_");
                    this.lightbox = this.posts.filter(post => post.slug == slug)[0].images[imageNumber];
                }
            },
            closeLightbox: function () {
                const hash = window.location.hash;
                const [_, slug, imageNumber] = hash.substring(hash.indexOf("lightbox")).split("_");
                window.location.hash = `#${slug}`;
                this.lightbox = null;
            }
        },
        watch: {
            posts: function (newValue) { if (newValue) this.handleHashChange(); }
        },
        data: {
            posts: [],
            lightbox: null
        }
    })        
</script>

</html>